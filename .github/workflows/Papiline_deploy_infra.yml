name: 'Infraestructura como C√≥digo - Terraform'

on:
  push:
    branches: [ main ]
    paths:
      - 'terraform/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'terraform/**'

# Configuraci√≥n de concurrencia para evitar despliegues simult√°neos
concurrency:
  group: terraform-${{ github.ref }}
  cancel-in-progress: true

jobs:
  terraform:
    name: 'Terraform'
    runs-on: ubuntu-latest
    environment: production
    env:
      TF_IN_AUTOMATION: true
      TF_INPUT: false
      TF_WORKSPACE: default
    
    steps:
      - name: 'Checkout C√≥digo'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necesario para que funcione la verificaci√≥n de cambios

      - name: 'Configurar Terraform'
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: '1.5.7'
          terraform_wrapper: false

      - name: 'Configurar Credenciales GCP'
        id: auth
        env:
          GCP_CREDENTIALS: ${{ secrets.GCP_CREDENTIALS }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
        run: |
          # Crear directorio para credenciales
          mkdir -p $GITHUB_WORKSPACE/.gcp
          
          # Guardar las credenciales de GCP en un archivo temporal
          echo "$GCP_CREDENTIALS" | base64 -d > $GITHUB_WORKSPACE/.gcp/credentials.json
          
          # Configurar variables de entorno necesarias
          echo "GOOGLE_APPLICATION_CREDENTIALS=$GITHUB_WORKSPACE/.gcp/credentials.json" >> $GITHUB_ENV
          echo "TF_VAR_project_id=$GCP_PROJECT_ID" >> $GITHUB_ENV
          echo "TF_VAR_ssh_public_key=$SSH_PUBLIC_KEY" >> $GITHUB_ENV
          echo "TF_VAR_allowed_ssh_cidr=0.0.0.0/0" >> $GITHUB_ENV
          
          # Verificar que el archivo de credenciales se cre√≥ correctamente
          echo "Verificando credenciales de GCP..."
          if [ -s "$GITHUB_WORKSPACE/.gcp/credentials.json" ]; then
            echo "‚úÖ Archivo de credenciales creado correctamente"
            echo "Primeros 100 caracteres del archivo:"
            head -c 100 "$GITHUB_WORKSPACE/.gcp/credentials.json"
          else
            echo "‚ùå Error: No se pudo crear el archivo de credenciales"
            echo "Contenido de GCP_CREDENTIALS (primeros 50 caracteres): ${GCP_CREDENTIALS:0:50}..."
            exit 1
          fi

      - name: 'Inicializar Terraform'
        id: init
        working-directory: ./terraform
        run: |
          terraform init -input=false -backend=false

      - name: 'Validar Formato de C√≥digo'
        id: fmt
        working-directory: ./terraform
        run: |
          terraform fmt -check -recursive
          echo "FMT_CHECK_PASSED=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: 'Validar Sintaxis de Terraform'
        id: validate
        working-directory: ./terraform
        run: |
          terraform validate -no-color

      - name: 'Plan de Ejecuci√≥n'
        id: plan
        if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
        working-directory: ./terraform
        run: |
          terraform plan -input=false -no-color -out=tfplan
          terraform show -no-color tfplan > tfplan.txt
        continue-on-error: true

      - name: 'Mostrar Plan de Ejecuci√≥n'
        if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
        working-directory: ./terraform
        run: |
          cat tfplan.txt

      - name: 'Aplicar Cambios (Solo en main)'
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        working-directory: ./terraform
        run: |
          # Verificar el plan antes de aplicar
          if [ ! -f "tfplan" ]; then
            echo "‚ùå Error: No se encontr√≥ el archivo de plan"
            exit 1
          fi
          
          echo "üîç Mostrando resumen del plan..."
          terraform show -no-color tfplan
          
          echo "üöÄ Aplicando cambios..."
          terraform apply -auto-approve -input=false tfplan || {
            echo "‚ùå Error al aplicar los cambios"
            exit 1
          }
          
          echo "‚úÖ Cambios aplicados exitosamente"

      - name: 'Mostrar Salidas de Terraform'
        if: always() && github.event_name == 'push'
        working-directory: ./terraform
        run: |
          echo "##[group]üìã Resumen del Despliegue"
          terraform output -raw resumen_despliegue 2>/dev/null || echo "No hay salidas definidas"
          echo "##[endgroup]"

      - name: 'Limpiar Archivos Temporales'
        if: always()
        run: |
          rm -f $GITHUB_WORKSPACE/gcp_creds.json
          rm -f $GITHUB_WORKSPACE/terraform/tfplan
          rm -f $GITHUB_WORKSPACE/terraform/tfplan.txt

      - name: 'Notificar Fallo en el Pipeline'
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const message = `‚ùå **Error en el despliegue de Infraestructura**
            
            **Workflow:** ${{ github.workflow }}
            **Ejecuci√≥n:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            **Commit:** [${process.env.GITHUB_SHA}](https://github.com/${{ github.repository }}/commit/${process.env.GITHUB_SHA})`;
            
            await github.rest.issues.createComment({
              issue_number: ${{ github.event.pull_request.number || 1 }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });